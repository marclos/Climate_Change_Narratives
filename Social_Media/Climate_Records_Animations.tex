\documentclass{article}
\usepackage{hyperref}
% \usepackage{animate}




\title{Communicating Climate Change with Weather Records}
\author{Marc Los Huertos}

\begin{document}
\maketitle

\section{Evaluating Terrestrial Meteorological Data}

\subsection{Selected History of Climate Science}

Geologists have known the climate has been changing over the Earth's history. But what causes these changes has been a major research area for over 100 years. There are numerous drivers that contribute to changing climates -- including the arrangement of the continents on the planet, the distance to the sun, energy generated by the sun, volanic activity, and the composition of the Earth's atmosphere. 

It's the last one that we'll spend time because the Earth's temperature are changing pretty dramatically over the last 100 years and the cause is no mystery -- the human activity that has released CO2 into the atmosphere. The two main sources of CO2 is from land use change, e.g. deforestration, and the burning of fossil fuels, e.g. coal, oil, and natural gas. 

The first to propose the role of CO2 on the Earth's atmosphere was a Swedish scientist Svante Arrhenius, who figured out that CO2 absorbs infarred light. Moreover, he deduced that the Earth's temperature was actually warmer than it might otherwise be if CO2 was not part of the Earth's atmoshere. 


\subsection{NOAA Data Records}

%ftp://ftp.ncdc.noaa.gov/pub/data/ghcn/v3/

\subsubsection{rNOAA Package and R}

R is an open source programming environment that has become one of the most popular tools for statiticians and data scientists. Capitalizing on the open source framework, a wide range of libraries or packages have been developed to faciliate data processing, analysis, and graphical displays. On such package is rNOAA developed to collect and display climate records stored on NOAA servers.


Using the package requires the use of a key. To maintain the integrity of the key, it's best to avoid posting the key in a public repository and to encryp the key to ensure it's not abused. 

\subsection{Selecting Weather Records by State}

\subsubsection{State Temperature Records}

There are numerous ways to analyze temperature records, where stations can be analyzed individually or records could be sampled and analyzed in spatially in grids. Each of these are valid approaches depending on the question to be addressed. 

In this case the question is ``Based on the longest state meterological record, is there a temperature trend?"

\subsection{Approach}

\subsubsection{List of Cities}

rNOAA has a simple function to list for each of the states and the weather stations in each. We'll use ncdc\_locs() functions to select each state and ncdc\_station() to obtain the station ids with the longest records. 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# List of States (alpha beta)}
\hlkwd{ncdc_locs}\hlstd{(}\hlkwc{locationcategoryid}\hlstd{=}\hlstr{'ST'}\hlstd{,} \hlkwc{limit}\hlstd{=}\hlnum{55}\hlstd{)}

\hlcom{# Alabama }
\hlcom{# ncdc_locs(locationid='FIPS:01', limit=52)}
\end{alltt}
\end{kframe}
\end{knitrout}

The function queries the NOAA website and retrieves state codes, ``FIPS:XX''.  

%NOTE: By default 25 records (cities) are retrieved. See \texttt{?ncdc_locs} to learn how to include arguments to obtain more records.  

NOTE2: It would be nice to make a map of how concentrated the stations spatially. 

%\subsubsection{Getting Data}

\subsubsection{Selection Stations}

With the state ids, we can then, get metadata for all the weather stations, which will work to get the longest records, using \texttt{ncdc\_stations()}. 

First, we subset the data for stations that actively collecting data. Then we'll sort to the active stations to find the one with the longest records. We will use these stations for our analysis. 
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# alabama stations.. sorted by the most recent}
\hlcom{# test <- ncdc_stations(datasetid='GHCND', }
\hlcom{# datatypeid = c("TMAX", "TMIN"), locationid='FIPS:01', }
\hlcom{# limit=1000, sortfield = 'maxdate', sortorder='desc')}

\hlstd{get_locationid} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{FIPS}\hlstd{)\{}
   \hlstd{fips} \hlkwb{=} \hlkwd{ncdc_locs}\hlstd{(}\hlkwc{locationcategoryid}\hlstd{=}\hlstr{'ST'}\hlstd{,} \hlkwc{limit}\hlstd{=}\hlnum{55}\hlstd{)}
   \hlstd{temp} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{State} \hlstd{= fips}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{name[FIPS],}
             \hlkwc{id} \hlstd{= fips}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{id[FIPS])}
   \hlstd{temp}\hlopt{$}\hlstd{id} \hlkwb{<-} \hlkwd{as.character}\hlstd{(temp}\hlopt{$}\hlstd{id)}
   \hlstd{temp}\hlopt{$}\hlstd{State} \hlkwb{<-} \hlkwd{as.character}\hlstd{(temp}\hlopt{$}\hlstd{State)}
   \hlkwd{return}\hlstd{(temp)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\subsubsection{Select State}

Using the rNOAA function ncdc\_locs(), we can queary NOAA's database to identify station codes (FIPS) by state. With the states and some territories, there are 55 FIPS for US weather stations. 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{fips} \hlkwb{=} \hlkwd{get_locationid}\hlstd{(}\hlnum{3}\hlstd{);} \hlkwd{str}\hlstd{(fips);}
\end{alltt}
\begin{verbatim}
## 'data.frame':	1 obs. of  2 variables:
##  $ State: chr "Arizona"
##  $ id   : chr "FIPS:04"
\end{verbatim}
\end{kframe}
\end{knitrout}

After 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{GSOM_Stations} \hlkwb{<-} \hlkwd{ncdc_stations}\hlstd{(}\hlkwc{datasetid}\hlstd{=}\hlstr{'GSOM'}\hlstd{,}
               \hlkwc{datatypeid} \hlstd{=} \hlkwd{c}\hlstd{(}\hlstr{"TMAX"}\hlstd{,} \hlstr{"TMIN"}\hlstd{),}
               \hlkwc{locationid}\hlstd{=fips}\hlopt{$}\hlstd{id,} \hlkwc{limit}\hlstd{=}\hlnum{1000}\hlstd{,}
               \hlkwc{sortfield} \hlstd{=} \hlstr{'maxdate'}\hlstd{,} \hlkwc{sortorder}\hlstd{=}\hlstr{'desc'}\hlstd{)}

\hlstd{GSOM_Recent} \hlkwb{=}
   \hlstd{GSOM_Stations}\hlopt{$}\hlstd{data[GSOM_Stations}\hlopt{$}\hlstd{data}\hlopt{$}\hlstd{maxdate}\hlopt{>=}\hlstr{'2021-11-01'}\hlstd{,]}

\hlstd{GSOM_Coverage} \hlkwb{=}
   \hlstd{GSOM_Recent[GSOM_Recent}\hlopt{$}\hlstd{datacoverage} \hlopt{>} \hlnum{0.92}\hlstd{,]}
\hlstd{GSOM_Sorted} \hlkwb{=}  \hlstd{GSOM_Coverage[}\hlkwd{order}\hlstd{(GSOM_Coverage}\hlopt{$}\hlstd{mindate),]}
\hlcom{#GSOM_Longest = }
 \hlcom{#  GSOM_Coverage[GSOM_Coverage$mindate == min(GSOM_Coverage$mindate),]}
\hlstd{GSOM_Longest} \hlkwb{=} \hlstd{GSOM_Sorted[}\hlnum{1}\hlstd{,]} \hlcom{#Pick longest}
\hlcom{# Second and Third for Comparisons}
\hlcom{# GSOM_Longest = GSOM_Sorted[3,] }
\hlcom{# GSOM_Longest = GSOM_Sorted[4,]}
\end{alltt}
\end{kframe}
\end{knitrout}

The record selected has the following metadata associated with it, which will be used for nameing, labeling, and mapping. 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{verbatim}
##     elevation    mindate    maxdate latitude             name datacoverage
## 193    1420.1 1893-07-01 2022-03-01  31.7119 TOMBSTONE, AZ US       0.9301
##                    id elevationUnit longitude
## 193 GHCND:USC00028619        METERS -110.0686
\end{verbatim}
\end{kframe}
\end{knitrout}

\subsubsection{Download GSOM Data using rnoaa}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## [1] 1893
\end{verbatim}
\end{kframe}
\end{knitrout}

\subsubsection{Functions to Collect and Clean GSOM}

To collect the data, I used a short function, but the download time is painfully slow because only 1 year can be obtained at a time. Might want to get a work around for this at some point. 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{get_GSOM} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{stid}\hlstd{,} \hlkwc{datatype}\hlstd{) \{}
   \hlstd{wtr}\hlkwb{<-}\hlkwd{list}\hlstd{()}  \hlcom{# create an empty list}
   \hlkwa{for} \hlstd{(i} \hlkwa{in} \hlstd{startyear}\hlopt{:}\hlnum{2021}\hlstd{) \{}
      \hlstd{start_date} \hlkwb{<-} \hlkwd{paste0}\hlstd{(i,} \hlstr{"-01-01"}\hlstd{)}
      \hlstd{end_date} \hlkwb{<-} \hlkwd{paste0}\hlstd{(i,} \hlstr{"-12-31"}\hlstd{)}

\hlcom{#save data portion to the list (elements named for the year}
      \hlstd{wtr[[}\hlkwd{as.character}\hlstd{(i)]]} \hlkwb{<-} \hlkwd{ncdc}\hlstd{(}\hlkwc{datasetid}\hlstd{=}\hlstr{'GSOM'}\hlstd{,}
         \hlkwc{stationid}\hlstd{=stid,} \hlkwc{datatypeid}\hlstd{=datatype,} \hlkwc{startdate} \hlstd{=}
         \hlstd{start_date,} \hlkwc{enddate} \hlstd{= end_date,} \hlkwc{limit}\hlstd{=}\hlnum{400}\hlstd{)}\hlopt{$}\hlstd{data}
   \hlstd{\}}
   \hlcom{#return the full list of data frames}
   \hlkwd{return}\hlstd{(wtr)}
\hlstd{\}}

\hlstd{stid} \hlkwb{=} \hlkwd{substr}\hlstd{(GSOM_Longest}\hlopt{$}\hlstd{id,} \hlnum{7}\hlstd{,} \hlnum{17}\hlstd{)}

\hlstd{get_GSOM2} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{stid}\hlstd{)\{}
   \hlstd{http.csv} \hlkwb{<-} \hlstr{"https://www.ncei.noaa.gov/data/global-summary-of-the-month/access/"}
   \hlkwd{read.csv}\hlstd{(}\hlkwd{paste}\hlstd{(http.csv, stid,} \hlstr{".csv"}\hlstd{,} \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{))}
\hlstd{\}}

\hlcom{# GSOM <- get_GSOM2(stid)}
\end{alltt}
\end{kframe}
\end{knitrout}

The function relies on two inputs, the station id and the measured parameter -- TMAX and TMIN in this case. After that, the data needs to be clean up quite a bit. 

Furthermore, I have converted units to Farenheit, which is not my favorite, but important for US consumption.

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{GSOM_TMAX} \hlkwb{<-} \hlkwd{get_GSOM}\hlstd{(GSOM_Longest}\hlopt{$}\hlstd{id,} \hlstr{'TMAX'}\hlstd{)}
\hlstd{GSOM_TMIN} \hlkwb{<-} \hlkwd{get_GSOM}\hlstd{(GSOM_Longest}\hlopt{$}\hlstd{id,} \hlstr{'TMIN'}\hlstd{)}
\hlstd{GSOM_PPT}  \hlkwb{<-} \hlkwd{get_GSOM}\hlstd{(GSOM_Longest}\hlopt{$}\hlstd{id,} \hlstr{'PRCP'}\hlstd{)}

\hlcom{# Bind the dataframes in the list }
\hlcom{# together into one large dataframe}

\hlstd{tbl_TMAX} \hlkwb{<-} \hlstd{dplyr}\hlopt{::}\hlkwd{bind_rows}\hlstd{(GSOM_TMAX)}
\hlstd{tbl_TMIN} \hlkwb{<-} \hlstd{dplyr}\hlopt{::}\hlkwd{bind_rows}\hlstd{(GSOM_TMIN)}
\hlstd{tbl_PPT} \hlkwb{<-} \hlstd{dplyr}\hlopt{::}\hlkwd{bind_rows}\hlstd{(GSOM_PPT)}

\hlkwd{class}\hlstd{(tbl_TMAX)} \hlcom{# [1] "tbl_df"  "tbl" "data.frame"}
\end{alltt}
\begin{verbatim}
## [1] "tbl_df"     "tbl"        "data.frame"
\end{verbatim}
\begin{alltt}
\hlstd{dfTbl_TMAX} \hlkwb{=} \hlkwd{as.data.frame}\hlstd{(tbl_TMAX)}
\hlstd{dfTbl_TMIN} \hlkwb{=} \hlkwd{as.data.frame}\hlstd{(tbl_TMIN)}
\hlstd{dfTbl_PPT} \hlkwb{=} \hlkwd{as.data.frame}\hlstd{(tbl_PPT)}

\hlkwd{class}\hlstd{(dfTbl_TMAX)} \hlcom{# [1] "data.frame"}
\end{alltt}
\begin{verbatim}
## [1] "data.frame"
\end{verbatim}
\begin{alltt}
\hlstd{dfTbl_TMAX}\hlopt{$}\hlstd{TMAX} \hlkwb{=} \hlstd{dfTbl_TMAX}\hlopt{$}\hlstd{value}\hlopt{*}\hlnum{9}\hlopt{/}\hlnum{5}\hlopt{+}\hlnum{32}
\hlstd{dfTbl_TMIN}\hlopt{$}\hlstd{TMIN} \hlkwb{=} \hlstd{dfTbl_TMIN}\hlopt{$}\hlstd{value}\hlopt{*}\hlnum{9}\hlopt{/}\hlnum{5}\hlopt{+}\hlnum{32}
\hlstd{dfTbl_PPT}\hlopt{$}\hlstd{PPT} \hlkwb{=} \hlstd{dfTbl_PPT}\hlopt{$}\hlstd{value}

\hlstd{dfTbl_TMAX}\hlopt{$}\hlstd{Date} \hlkwb{=} \hlkwd{as.Date}\hlstd{(dfTbl_TMAX}\hlopt{$}\hlstd{date)}
\hlstd{dfTbl_TMIN}\hlopt{$}\hlstd{Date} \hlkwb{=} \hlkwd{as.Date}\hlstd{(dfTbl_TMIN}\hlopt{$}\hlstd{date)}
\hlstd{dfTbl_PPT}\hlopt{$}\hlstd{Date} \hlkwb{=} \hlkwd{as.Date}\hlstd{(dfTbl_PPT}\hlopt{$}\hlstd{date)}

\hlstd{dfTbl_TMAX} \hlkwb{<-} \hlkwd{subset}\hlstd{(dfTbl_TMAX,} \hlkwc{select}\hlstd{=}\hlkwd{c}\hlstd{(Date, station, TMAX))}
\hlstd{dfTbl_TMIN} \hlkwb{<-} \hlkwd{subset}\hlstd{(dfTbl_TMIN,} \hlkwc{select}\hlstd{=}\hlkwd{c}\hlstd{(Date, TMIN))}
\hlstd{dfTbl_PPT} \hlkwb{<-} \hlkwd{subset}\hlstd{(dfTbl_PPT,} \hlkwc{select}\hlstd{=}\hlkwd{c}\hlstd{(Date, PPT))}

\hlstd{dfTbl_TMAX[}\hlnum{1}\hlstd{,]}
\end{alltt}
\begin{verbatim}
##         Date           station   TMAX
## 1 1893-07-01 GHCND:USC00028619 96.674
\end{verbatim}
\begin{alltt}
\hlstd{GSOM} \hlkwb{<-} \hlkwd{merge}\hlstd{(dfTbl_TMAX, dfTbl_TMIN,} \hlkwc{by}\hlstd{=}\hlstr{"Date"}\hlstd{)}
\hlstd{GSOM} \hlkwb{<-} \hlkwd{merge}\hlstd{(GSOM, dfTbl_PPT,} \hlkwc{by}\hlstd{=}\hlstr{"Date"}\hlstd{)}

\hlstd{GSOM}\hlopt{$}\hlstd{Month} \hlkwb{=} \hlkwd{as.numeric}\hlstd{(}\hlkwd{format}\hlstd{(}\hlkwd{as.Date}\hlstd{(GSOM}\hlopt{$}\hlstd{Date),} \hlkwc{format} \hlstd{=} \hlstr{"%m"}\hlstd{))}
\hlstd{GSOM}\hlopt{$}\hlstd{Year} \hlkwb{=} \hlkwd{as.numeric}\hlstd{(}\hlkwd{format}\hlstd{(}\hlkwd{as.Date}\hlstd{(GSOM}\hlopt{$}\hlstd{Date),} \hlkwc{format} \hlstd{=} \hlstr{"%Y"}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}

\subsubsection{Function to Evaluate Monthy Trends}

Function to evaluate each month and determine if there is a trend. At somepoint, I'll have to the stats correcting for the autocorrelation. 



Evaluate both TMAX and TMIN in GSOM by Year using MonthEvalStats() function. 
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{MonthEvalStatsOLD} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{GSOM}\hlstd{) \{}
\hlstd{sumstats} \hlkwb{=} \hlnum{NA}
\hlkwa{for} \hlstd{(m} \hlkwa{in} \hlnum{1}\hlopt{:}\hlnum{12}\hlstd{)\{}
  \hlstd{TMIN.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMIN}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}
  \hlstd{TMAX.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}
   \hlstd{PPT.lm}  \hlkwb{=} \hlkwd{lm}\hlstd{(PPT}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}

 \hlstd{sumstats} \hlkwb{=} \hlkwd{rbind}\hlstd{(sumstats,}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month} \hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"TMIN"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(TMIN.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(TMIN.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(TMIN.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]),}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month} \hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"TMAX"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(TMAX.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(TMAX.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(TMAX.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]),}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month}\hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"PPT"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(PPT.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(PPT.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(PPT.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]))}

\hlstd{\}}

\hlstd{sumstats}\hlkwb{=}\hlkwd{data.frame}\hlstd{(sumstats)[}\hlopt{-}\hlnum{1}\hlstd{,]}
\hlkwd{rownames}\hlstd{(sumstats)}\hlkwb{<-}\hlkwa{NULL}

\hlstd{sumstats}\hlopt{$}\hlstd{Symbol} \hlkwb{=} \hlstr{""}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.05}\hlstd{]} \hlkwb{=} \hlstr{"*"}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.01}\hlstd{]} \hlkwb{=} \hlstr{"**"}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.001}\hlstd{]} \hlkwb{=} \hlstr{"***"}
\hlstd{sumstats[,}\hlkwd{c}\hlstd{(}\hlnum{7}\hlstd{,}\hlnum{9}\hlstd{)]}
\hlkwd{return}\hlstd{(sumstats)}
\hlstd{\}}

\hlstd{MonthEvalStats} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{GSOM}\hlstd{) \{}
\hlstd{sumstats} \hlkwb{=} \hlnum{NA}
\hlkwa{for} \hlstd{(m} \hlkwa{in} \hlnum{1}\hlopt{:}\hlnum{12}\hlstd{)\{}
  \hlstd{TMIN.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMIN}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}
  \hlstd{TMAX.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}
   \hlstd{PPT.lm}  \hlkwb{=} \hlkwd{lm}\hlstd{(PPT}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Month}\hlopt{==}\hlstd{m,])}

 \hlstd{sumstats} \hlkwb{=} \hlkwd{rbind}\hlstd{(sumstats,}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month} \hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"TMIN"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(TMIN.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(TMIN.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(TMIN.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]),}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month} \hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"TMAX"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(TMAX.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(TMAX.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(TMAX.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]),}
   \hlkwd{data.frame}\hlstd{(}\hlkwc{Month}\hlstd{= m,} \hlkwc{Param}\hlstd{=}\hlstr{"PPT"}\hlstd{,} \hlkwc{Slope} \hlstd{=} \hlkwd{coef}\hlstd{(PPT.lm)[}\hlnum{2}\hlstd{],}
   \hlkwc{r2} \hlstd{=} \hlkwd{summary}\hlstd{(PPT.lm)}\hlopt{$}\hlstd{r.squared,} \hlkwc{p_value}\hlstd{=} \hlkwd{anova}\hlstd{(PPT.lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]))}

\hlstd{\}} \hlcom{#end loop}

\hlstd{sumstats}\hlkwb{=}\hlkwd{data.frame}\hlstd{(sumstats)[}\hlopt{-}\hlnum{1}\hlstd{,]}
\hlkwd{rownames}\hlstd{(sumstats)}\hlkwb{<-}\hlkwa{NULL}
\hlkwd{head}\hlstd{(sumstats)}

\hlstd{sumstats}\hlopt{$}\hlstd{Symbol} \hlkwb{=} \hlstr{""}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.05}\hlstd{]} \hlkwb{=} \hlstr{"*"}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.01}\hlstd{]} \hlkwb{=} \hlstr{"**"}
\hlstd{sumstats}\hlopt{$}\hlstd{Symbol[sumstats}\hlopt{$}\hlstd{p_value} \hlopt{<} \hlnum{0.001}\hlstd{]} \hlkwb{=} \hlstr{"***"}
\hlkwd{return}\hlstd{(sumstats)}
\hlstd{\}}

\hlcom{# test function}
\hlstd{sumstats} \hlkwb{=} \hlkwd{MonthEvalStats}\hlstd{(GSOM[}\hlnum{500}\hlopt{:}\hlnum{4000}\hlstd{,])}
\end{alltt}
\end{kframe}
\end{knitrout}

\subsubsection{Function to report Probabilities}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{report_prob} \hlkwb{<-}\hlkwa{function}\hlstd{(}\hlkwc{pvalue}\hlstd{)\{}
   \hlkwa{if}\hlstd{(pvalue} \hlopt{>} \hlnum{0.05}\hlstd{)} \hlkwd{return}\hlstd{(}\hlstr{"> 0.05 (Not Significant)"}\hlstd{)}
   \hlkwa{if}\hlstd{(pvalue} \hlopt{<} \hlnum{0.05} \hlopt{&} \hlstd{pvalue} \hlopt{>=} \hlnum{0.001}\hlstd{)} \hlkwd{return}\hlstd{(}
      \hlkwd{paste}\hlstd{(}\hlstr{"="}\hlstd{,} \hlkwd{round}\hlstd{(pvalue,} \hlnum{3}\hlstd{),} \hlstr{"(Statistically Significant)"}\hlstd{))}
   \hlcom{#if(pvalue < 0.01) print(round(pvalue, 4))}
   \hlkwa{if}\hlstd{(pvalue} \hlopt{<} \hlnum{0.001}\hlstd{)} \hlkwd{return}\hlstd{(}\hlstr{"< 0.001 (Statisically Significant)"}\hlstd{)}
\hlstd{\}}

\hlcom{#test function}
\hlkwd{report_prob}\hlstd{(}\hlnum{0.0032}\hlstd{)}

\hlstd{report_prob2} \hlkwb{<-}\hlkwa{function}\hlstd{(}\hlkwc{lm}\hlstd{)\{}
   \hlcom{# lm=GSOM.lm}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{>} \hlnum{0.05}\hlstd{)\{}
         \hlkwd{return}\hlstd{(}\hlstr{"p-value > 0.05 (Not Significant)"}\hlstd{)}
      \hlstd{\}}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.05} \hlopt{&}
      \hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{>=} \hlnum{0.001}\hlstd{)\{}
         \hlkwd{return}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{"Change "}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{coef}\hlstd{(lm)[}\hlnum{2}\hlstd{]}\hlopt{*}\hlnum{356.25}\hlopt{*}\hlnum{100}\hlstd{,} \hlnum{1}\hlstd{),}
         \hlstr{"/100 years, "}\hlstd{,} \hlstr{"p-value ="}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{],} \hlnum{3}\hlstd{),}
         \hlstr{"(Statistically Significant)"}\hlstd{,} \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{))}
      \hlstd{\}}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.001}\hlstd{) \{}
         \hlkwd{return}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{"Change "}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{coef}\hlstd{(lm)[}\hlnum{2}\hlstd{]}\hlopt{*}\hlnum{325.25}\hlopt{*}\hlnum{100}\hlstd{,} \hlnum{1}\hlstd{),}
         \hlstr{"/100 years, "}\hlstd{,} \hlstr{"p-value < 0.001 (Statistically Significant)"}\hlstd{,}
         \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{))}
   \hlstd{\}}
\hlstd{\}}

\hlstd{report_prob3} \hlkwb{<-}\hlkwa{function}\hlstd{(}\hlkwc{lm}\hlstd{)\{}
   \hlcom{#lm=Drought.run.lm}
   \hlstd{temp} \hlkwb{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{change} \hlstd{=} \hlnum{NA}\hlstd{,} \hlkwc{p_value}\hlstd{=}\hlnum{NA}\hlstd{,} \hlkwc{note}\hlstd{=}\hlnum{NA}\hlstd{)}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{>} \hlnum{0.05}\hlstd{)\{}
      \hlstd{temp[,}\hlnum{1}\hlstd{]} \hlkwb{<-} \hlstr{""}\hlstd{;}
      \hlstd{temp[,}\hlnum{2}\hlstd{]} \hlkwb{<-} \hlstr{"p-value > 0.05"}\hlstd{;}
      \hlstd{temp[,}\hlnum{3}\hlstd{]} \hlkwb{<-} \hlstr{"(Not Significant)"}
      \hlkwd{return}\hlstd{(temp)}
      \hlstd{\}}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.05} \hlopt{&}
      \hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{>=} \hlnum{0.001}\hlstd{)\{}
      \hlstd{temp[,}\hlnum{1}\hlstd{]} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlstr{"Change: "}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{coef}\hlstd{(lm)[}\hlnum{2}\hlstd{]}\hlopt{*}\hlnum{356.25}\hlopt{*}\hlnum{100}\hlstd{,} \hlnum{1}\hlstd{),} \hlstr{"째F/100 years"}\hlstd{,} \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{);}
      \hlstd{temp[,}\hlnum{2}\hlstd{]} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlstr{"p-value = "}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{],} \hlnum{3}\hlstd{),} \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{);}
      \hlstd{temp[,}\hlnum{3}\hlstd{]} \hlkwb{<-} \hlstr{" (Statistically Significant)"}
      \hlkwd{return}\hlstd{(temp)}
      \hlstd{\}}
   \hlkwa{if}\hlstd{(}\hlkwd{anova}\hlstd{(lm)}\hlopt{$}\hlstr{'Pr(>F)'}\hlstd{[}\hlnum{1}\hlstd{]} \hlopt{<} \hlnum{0.001}\hlstd{) \{}
      \hlstd{temp[,}\hlnum{1}\hlstd{]} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlstr{"Change: "}\hlstd{,} \hlkwd{round}\hlstd{(}\hlkwd{coef}\hlstd{(lm)[}\hlnum{2}\hlstd{]}\hlopt{*}\hlnum{356.25}\hlopt{*}\hlnum{100}\hlstd{,} \hlnum{1}\hlstd{),} \hlstr{"째F/100 years"}\hlstd{,} \hlkwc{sep}\hlstd{=}\hlstr{""}\hlstd{);}
      \hlstd{temp[,}\hlnum{2}\hlstd{]} \hlkwb{<-} \hlstr{"p-value < 0.001"}\hlstd{;}
      \hlstd{temp[,}\hlnum{3}\hlstd{]} \hlkwb{<-} \hlstr{" (Statistically Significant)"}
      \hlkwd{return}\hlstd{(temp)}
   \hlstd{\}}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{Communicating Long-term Weather Records}

\subsection{Total Records and Post 1975 Records}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{setwd}\hlstd{(}\hlstr{"/home/CAMPUS/mwl04747/github/Climate_Change_Narratives/Social_Media"}\hlstd{)}
\hlkwd{png}\hlstd{(}\hlkwd{paste0}\hlstd{(}\hlstr{"png//"}\hlstd{, fips}\hlopt{$}\hlstd{State,} \hlstr{"-"}\hlstd{, stid,} \hlstr{"-GSOMmonthly.png"}\hlstd{),} \hlkwc{width} \hlstd{=} \hlnum{480}\hlstd{,} \hlkwc{height} \hlstd{=} \hlnum{320}\hlstd{,} \hlkwc{units} \hlstd{=} \hlstr{"px"}\hlstd{,} \hlkwc{pointsize} \hlstd{=} \hlnum{12}\hlstd{,} \hlkwc{bg} \hlstd{=} \hlstr{"white"}\hlstd{)}
\hlkwd{par}\hlstd{(}\hlkwc{las}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{mfrow}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,}\hlnum{1}\hlstd{))}
\hlkwd{plot}\hlstd{(TMAX}\hlopt{~}\hlstd{Date, GSOM,} \hlkwc{pch}\hlstd{=}\hlnum{20}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.5}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"째F"}\hlstd{)}
\hlstd{GSOM.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX}\hlopt{~}\hlstd{Date, GSOM)}
\hlstd{pred_dates} \hlkwb{<-}\hlkwd{data.frame}\hlstd{(}\hlkwc{Date} \hlstd{= GSOM}\hlopt{$}\hlstd{Date);}
\hlkwd{nrow}\hlstd{(pred_dates);}\hlcom{# pred_dates}
\end{alltt}
\begin{verbatim}
## [1] 1398
\end{verbatim}
\begin{alltt}
\hlcom{#Predits the values with confidence interval }
\hlstd{ci} \hlkwb{<-} \hlkwd{predict}\hlstd{(GSOM.lm,} \hlkwc{newdata} \hlstd{= pred_dates,}
              \hlkwc{interval} \hlstd{=} \hlstr{'confidence'}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{1}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"gray50"}\hlstd{)}

\hlcom{# Post 1975}
\hlstd{GSOM.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX}\hlopt{~}\hlstd{Date, GSOM[GSOM}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{,])}
\hlstd{pred_dates} \hlkwb{<-}\hlkwd{data.frame}\hlstd{(}\hlkwc{Date} \hlstd{= GSOM}\hlopt{$}\hlstd{Date[GSOM}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{]);}
\hlkwd{nrow}\hlstd{(pred_dates);} \hlcom{#pred_dates}
\end{alltt}
\begin{verbatim}
## [1] 523
\end{verbatim}
\begin{alltt}
\hlcom{#Predits the values with confidence interval }
\hlstd{ci} \hlkwb{<-} \hlkwd{predict}\hlstd{(GSOM.lm,} \hlkwc{newdata} \hlstd{= pred_dates,}
              \hlkwc{interval} \hlstd{=} \hlstr{'confidence'}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{1}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{2}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"darkorange"}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date, ci[,}\hlnum{3}\hlstd{],} \hlkwc{col}\hlstd{=}\hlstr{"darkorange"}\hlstd{)}
\hlstd{location_index} \hlkwb{=} \hlkwd{round}\hlstd{(}\hlkwd{length}\hlstd{(GSOM[GSOM}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{,]}\hlopt{$}\hlstd{Date)} \hlopt{*} \hlnum{0.99}\hlstd{,}\hlnum{0}\hlstd{)}
\hlkwd{text}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date[location_index], ci[location_index,}\hlnum{3}\hlstd{],}
     \hlkwd{paste}\hlstd{(}\hlkwd{report_prob3}\hlstd{(GSOM.lm))[}\hlnum{2}\hlstd{],} \hlkwc{pos}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{1.0}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)}
\hlcom{#abline(coef(lm(TMAX~Date, GSOM)), col="black")}
\hlcom{#abline(coef(lm(TMAX~Date, GSOM[GSOM$Year>1975,])), col="red")}
\hlkwd{dev.off}\hlstd{()}
\end{alltt}
\begin{verbatim}
## pdf 
##   2
\end{verbatim}
\end{kframe}
\end{knitrout}

The noise in the data suggest that there is no trend, but it's tricky because the seasonal variation dominates the source of varition. Is there a way to "filter" out the seasonal effect?

\subsection{Filtering Seasonal Effect}

Method 1 Filtering by Monthly Mean 

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{TMAX.Monthly.means} \hlkwb{=} \hlkwd{aggregate}\hlstd{(TMAX}\hlopt{~}\hlstd{Month, GSOM, mean)}
\hlkwd{names}\hlstd{(TMAX.Monthly.means)}\hlkwb{=}\hlkwd{c}\hlstd{(}\hlstr{"Month"}\hlstd{,} \hlstr{"TMAXmean"}\hlstd{)}
\hlstd{GSOM.2} \hlkwb{=} \hlkwd{merge}\hlstd{(GSOM, TMAX.Monthly.means,} \hlkwc{by}\hlstd{=}\hlstr{"Month"}\hlstd{)}
\hlstd{GSOM.2}\hlopt{$}\hlstd{TMAX.anom} \hlkwb{=} \hlstd{GSOM.2}\hlopt{$}\hlstd{TMAX} \hlopt{-} \hlstd{GSOM.2}\hlopt{$}\hlstd{TMAXmean}

\hlstd{TMIN.Monthly.means} \hlkwb{=} \hlkwd{aggregate}\hlstd{(TMIN}\hlopt{~}\hlstd{Month, GSOM, mean)}
\hlkwd{names}\hlstd{(TMIN.Monthly.means)}\hlkwb{=}\hlkwd{c}\hlstd{(}\hlstr{"Month"}\hlstd{,} \hlstr{"TMINmean"}\hlstd{)}
\hlstd{GSOM.2} \hlkwb{=} \hlkwd{merge}\hlstd{(GSOM.2, TMIN.Monthly.means,} \hlkwc{by}\hlstd{=}\hlstr{"Month"}\hlstd{)}
\hlstd{GSOM.2}\hlopt{$}\hlstd{TMIN.anom} \hlkwb{=} \hlstd{GSOM.2}\hlopt{$}\hlstd{TMIN} \hlopt{-} \hlstd{GSOM.2}\hlopt{$}\hlstd{TMINmean}


\hlkwd{png}\hlstd{(}\hlkwd{paste0}\hlstd{(}\hlstr{"png//"}\hlstd{, fips}\hlopt{$}\hlstd{State,} \hlstr{"-"}\hlstd{, stid,} \hlstr{"-GSOM-anomoly.png"}\hlstd{),} \hlkwc{width} \hlstd{=} \hlnum{480}\hlstd{,} \hlkwc{height} \hlstd{=} \hlnum{320}\hlstd{,} \hlkwc{units} \hlstd{=} \hlstr{"px"}\hlstd{,} \hlkwc{pointsize} \hlstd{=} \hlnum{12}\hlstd{,} \hlkwc{bg} \hlstd{=} \hlstr{"white"}\hlstd{)}
\hlkwd{par}\hlstd{(}\hlkwc{las}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{mfrow}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,}\hlnum{1}\hlstd{))}
\hlkwd{par}\hlstd{(}\hlkwc{las}\hlstd{=}\hlnum{1}\hlstd{)}
\hlkwd{plot}\hlstd{(TMAX.anom}\hlopt{~}\hlstd{Date, GSOM.2,} \hlkwc{pch}\hlstd{=}\hlnum{20}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.5}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Max. Temp (anomaly) 째F"}\hlstd{)}
\hlstd{GSOM.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX.anom}\hlopt{~}\hlstd{Date, GSOM.2)}
\hlstd{pred_dates} \hlkwb{<-}\hlkwd{data.frame}\hlstd{(}\hlkwc{Date} \hlstd{= GSOM.2}\hlopt{$}\hlstd{Date);}
\hlkwd{nrow}\hlstd{(pred_dates);} \hlcom{#pred_dates}
\end{alltt}
\begin{verbatim}
## [1] 1398
\end{verbatim}
\begin{alltt}
\hlcom{#Predits the values with confidence interval }
\hlstd{ci} \hlkwb{<-} \hlkwd{predict}\hlstd{(GSOM.lm,} \hlkwc{newdata} \hlstd{= pred_dates,}
              \hlkwc{interval} \hlstd{=} \hlstr{'confidence'}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{1}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"gray50"}\hlstd{)}

\hlstd{ymax}\hlkwb{=}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)} \hlopt{-} \hlstd{(}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)}\hlopt{-}\hlkwd{min}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom))}\hlopt{*}\hlnum{.3}
\hlstd{ymax2} \hlkwb{<-} \hlstd{ymax} \hlopt{-} \hlstd{(}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)}\hlopt{-}\hlkwd{min}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom))}\hlopt{*}\hlnum{.1}

\hlstd{location_index} \hlkwb{=} \hlkwd{round}\hlstd{(}\hlkwd{length}\hlstd{(GSOM.2[GSOM.2}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{,]}\hlopt{$}\hlstd{Date)} \hlopt{*} \hlnum{0.99}\hlstd{,}\hlnum{3}\hlstd{)}
\hlkwd{text}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date[location_index], ymax,}
     \hlkwd{paste}\hlstd{(}\hlkwd{report_prob3}\hlstd{(GSOM.lm))[}\hlnum{1}\hlstd{],} \hlkwc{pos}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.9}\hlstd{)}
\hlkwd{text}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date[location_index], ymax2,}
     \hlkwd{paste}\hlstd{(}\hlkwd{report_prob3}\hlstd{(GSOM.lm))[}\hlnum{2}\hlstd{],} \hlkwc{pos}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.9}\hlstd{)}

\hlcom{# Post 1975}
\hlstd{GSOM.lm} \hlkwb{=} \hlkwd{lm}\hlstd{(TMAX.anom}\hlopt{~}\hlstd{Date, GSOM.2[GSOM.2}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{,])}
\hlstd{pred_dates} \hlkwb{<-}\hlkwd{data.frame}\hlstd{(}\hlkwc{Date} \hlstd{= GSOM.2}\hlopt{$}\hlstd{Date[GSOM.2}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{]);}
\hlkwd{nrow}\hlstd{(pred_dates);} \hlcom{#pred_dates}
\end{alltt}
\begin{verbatim}
## [1] 523
\end{verbatim}
\begin{alltt}
\hlcom{#Predits the values with confidence interval }
\hlstd{ci} \hlkwb{<-} \hlkwd{predict}\hlstd{(GSOM.lm,} \hlkwc{newdata} \hlstd{= pred_dates,}
              \hlkwc{interval} \hlstd{=} \hlstr{'confidence'}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{1}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date,} \hlkwd{as.numeric}\hlstd{(ci[,}\hlnum{2}\hlstd{]),} \hlkwc{col}\hlstd{=}\hlstr{"darkorange"}\hlstd{)}
\hlkwd{lines}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date, ci[,}\hlnum{3}\hlstd{],} \hlkwc{col}\hlstd{=}\hlstr{"darkorange"}\hlstd{)}

\hlstd{ymax}\hlkwb{=}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)} \hlopt{-} \hlstd{(}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)}\hlopt{-}\hlkwd{min}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom))}\hlopt{*}\hlnum{.7}
\hlstd{ymax2} \hlkwb{<-} \hlstd{ymax} \hlopt{-} \hlstd{(}\hlkwd{max}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom)}\hlopt{-}\hlkwd{min}\hlstd{(GSOM.2}\hlopt{$}\hlstd{TMAX.anom))}\hlopt{*}\hlnum{.1}

\hlstd{location_index} \hlkwb{=} \hlkwd{round}\hlstd{(}\hlkwd{length}\hlstd{(GSOM.2[GSOM.2}\hlopt{$}\hlstd{Year}\hlopt{>}\hlnum{1975}\hlstd{,]}\hlopt{$}\hlstd{Date)} \hlopt{*} \hlnum{0.99}\hlstd{,}\hlnum{0}\hlstd{)}
\hlkwd{text}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date[location_index], ymax,}
     \hlkwd{paste}\hlstd{(}\hlkwd{report_prob3}\hlstd{(GSOM.lm))[}\hlnum{1}\hlstd{],} \hlkwc{pos}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.9}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)}
\hlkwd{text}\hlstd{(pred_dates}\hlopt{$}\hlstd{Date[location_index], ymax2,}
     \hlkwd{paste}\hlstd{(}\hlkwd{report_prob3}\hlstd{(GSOM.lm))[}\hlnum{2}\hlstd{],} \hlkwc{pos}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{.9}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)}
\hlkwd{dev.off}\hlstd{()}
\end{alltt}
\begin{verbatim}
## pdf 
##   2
\end{verbatim}
\end{kframe}
\end{knitrout}


























































